name: Neworld Multi Account Signin

on:
  schedule:
    # slot2 北京 12:10-12:20 (UTC 04:10-04:20)
    - cron: "10 4 * * *"
    - cron: "15 4 * * *"
    - cron: "20 4 * * *"

    # slot3 北京 16:10-16:20 (UTC 08:10-08:20)
    - cron: "10 8 * * *"
    - cron: "15 8 * * *"
    - cron: "20 8 * * *"

    # slot4 北京 20:10-20:20 (UTC 12:10-12:20)
    - cron: "10 12 * * *"
    - cron: "15 12 * * *"
    - cron: "20 12 * * *"

  workflow_dispatch:

permissions:
  contents: write

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - run: pip install selenium webdriver-manager requests

      - name: Select account by time slot
        shell: bash
        run: |
          UTC_HOUR=$(date -u +"%H")
          echo "UTC hour = $UTC_HOUR"

          pick() {
            SLOT="$1"
            USER="$2"
            PASS="$3"

            if [ -z "$USER" ] || [ -z "$PASS" ]; then
              echo "$SLOT empty, skip"
              exit 0
            fi

            echo "SLOT_NAME=$SLOT" >> $GITHUB_ENV
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          if [ "$UTC_HOUR" = "04" ]; then
            pick "SLOT2" "${{ secrets.NW_SLOT2_USER }}" "${{ secrets.NW_SLOT2_PASS }}"
          elif [ "$UTC_HOUR" = "08" ]; then
            pick "SLOT3" "${{ secrets.NW_SLOT3_USER }}" "${{ secrets.NW_SLOT3_PASS }}"
          elif [ "$UTC_HOUR" = "12" ]; then
            pick "SLOT4" "${{ secrets.NW_SLOT4_USER }}" "${{ secrets.NW_SLOT4_PASS }}"
          else
            echo "Not in slot window"
            exit 0
          fi

      - name: Run signin
        run: python help.py
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

      - name: Commit mark
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "bot@github.com"

          if ls SIGNED_*.txt 1> /dev/null 2>&1; then
            git add SIGNED_*.txt
            git commit -m "mark: signed" || echo "no change"
            git push
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_*.txt
