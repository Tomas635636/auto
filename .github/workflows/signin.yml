name: Neworld Multi Account Signin

on:
  schedule:
    # ===== SLOT1 北京 07:11 / 07:17 / 07:23 =====
    - cron: "11 23 * * *"
    - cron: "17 23 * * *"
    - cron: "23 23 * * *"

    # ===== SLOT2 北京 11:09 / 11:16 / 11:22 =====
    - cron: "9 3 * * *"
    - cron: "16 3 * * *"
    - cron: "22 3 * * *"

    # ===== SLOT3 北京 15:08 / 15:14 / 15:21 =====
    - cron: "8 7 * * *"
    - cron: "14 7 * * *"
    - cron: "21 7 * * *"

    # ===== SLOT4 北京 19:07 / 19:13 / 19:19 =====
    - cron: "7 11 * * *"
    - cron: "13 11 * * *"
    - cron: "19 11 * * *"

  workflow_dispatch:
    inputs:
      test_slot:
        description: "选择要测试的账号槽位（SLOT1~SLOT4）"
        required: true
        default: "SLOT2"
        type: choice
        options:
          - SLOT1
          - SLOT2
          - SLOT3
          - SLOT4

permissions:
  contents: write

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager requests

      - name: Select account by time slot
        shell: bash
        run: |
          UTC_HOUR=$(date -u +"%H")
          UTC_MIN=$(date -u +"%M")
          echo "UTC time: $UTC_HOUR:$UTC_MIN"

          pick_slot() {
            SLOT="$1"
            USER_VAR="NW_${SLOT}_USER"
            PASS_VAR="NW_${SLOT}_PASS"

            USER="${!USER_VAR}"
            PASS="${!PASS_VAR}"

            echo "SLOT_NAME=$SLOT" >> $GITHUB_ENV

            # ✅ 未配置也不要 exit，让 help.py 去发“未配置”通知
            if [ -z "$USER" ] || [ -z "$PASS" ]; then
              echo "Slot $SLOT has no account configured."
              echo "SLOT_CONFIGURED=0" >> $GITHUB_ENV
              echo "USERNAME=" >> $GITHUB_ENV
              echo "PASSWORD=" >> $GITHUB_ENV
              return 0
            fi

            echo "SLOT_CONFIGURED=1" >> $GITHUB_ENV
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          # ===== 手动触发：用你选择的 slot（注意：不再 exit 0）=====
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run detected, using slot: ${{ inputs.test_slot }}"
            pick_slot "${{ inputs.test_slot }}"
          else
            # ===== 自动定时 =====
            if [ "$UTC_HOUR" = "23" ]; then
              pick_slot "SLOT1"
            elif [ "$UTC_HOUR" = "03" ]; then
              pick_slot "SLOT2"
            elif [ "$UTC_HOUR" = "07" ]; then
              pick_slot "SLOT3"
            elif [ "$UTC_HOUR" = "11" ]; then
              pick_slot "SLOT4"
            else
              echo "Not in any slot window, exit."
              # 不在窗口就直接结束整个 job
              exit 0
            fi
          fi

        env:
          NW_SLOT1_USER: ${{ secrets.NW_SLOT1_USER }}
          NW_SLOT1_PASS: ${{ secrets.NW_SLOT1_PASS }}
          NW_SLOT2_USER: ${{ secrets.NW_SLOT2_USER }}
          NW_SLOT2_PASS: ${{ secrets.NW_SLOT2_PASS }}
          NW_SLOT3_USER: ${{ secrets.NW_SLOT3_USER }}
          NW_SLOT3_PASS: ${{ secrets.NW_SLOT3_PASS }}
          NW_SLOT4_USER: ${{ secrets.NW_SLOT4_USER }}
          NW_SLOT4_PASS: ${{ secrets.NW_SLOT4_PASS }}

      - name: Run signin
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python help.py

      - name: Commit signin logs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "bot@github.com"

          git add SIGNED_SLOT*.txt run.log || true
          git commit -m "chore: update signin logs" || echo "Nothing to commit"
          git push || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_SLOT*.txt
