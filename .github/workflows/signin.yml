name: Neworld Multi Account Signin

on:
  schedule:
    # ========== slot1 åŒ—äº¬ 08:10-08:20 (UTC 00:10-00:20) ==========
    - cron: "10 0 * * *"
    - cron: "15 0 * * *"
    - cron: "20 0 * * *"

    # ========== slot2 åŒ—äº¬ 12:10-12:20 (UTC 04:10-04:20) ==========
    - cron: "10 4 * * *"
    - cron: "15 4 * * *"
    - cron: "20 4 * * *"

    # ========== slot3 åŒ—äº¬ 16:10-16:20 (UTC 08:10-08:20) ==========
    - cron: "10 8 * * *"
    - cron: "15 8 * * *"
    - cron: "20 8 * * *"

    # ========== slot4 åŒ—äº¬ 20:10-20:20 (UTC 12:10-12:20) ==========
    - cron: "10 12 * * *"
    - cron: "15 12 * * *"
    - cron: "20 12 * * *"

  workflow_dispatch:
    inputs:
      force_run:
        description: "Force run ignore time window (for test)"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# ========= å¿…é¡»ç»™å†™æƒé™ï¼Œå¦åˆ™æ— æ³•æäº¤ SIGNED æ–‡ä»¶ =========
permissions:
  contents: write

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      # ========== æ‹‰å–ä»“åº“ ==========
      - name: Checkout repo
        uses: actions/checkout@v4

      # ========== Python çŽ¯å¢ƒ ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ========== å®‰è£…ä¾èµ– ==========
      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager requests

      # ========== æ ¹æ® UTC æ—¶é—´é€‰æ‹© slot ==========
      - name: Select account by time slot
        shell: bash
        run: |
          UTC_HOUR=$(date -u +"%H")
          UTC_MIN=$(date -u +"%M")
          echo "UTC time: $UTC_HOUR:$UTC_MIN"

          pick_slot() {
            SLOT="$1"
            USER_VAR="NW_${SLOT}_USER"
            PASS_VAR="NW_${SLOT}_PASS"

            USER="${!USER_VAR}"
            PASS="${!PASS_VAR}"

            if [ -z "$USER" ] || [ -z "$PASS" ]; then
              echo "Slot $SLOT has no account configured. Exit."
              exit 0
            fi

            echo "SLOT_NAME=$SLOT" >> $GITHUB_ENV
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV

            echo "âœ… Selected $SLOT"
          }

          # ====== è‡ªåŠ¨æŒ‰æ—¶é—´é€‰æ‹© ======
          if [ "$UTC_HOUR" = "00" ]; then
            pick_slot "SLOT1"

          elif [ "$UTC_HOUR" = "04" ]; then
            pick_slot "SLOT2"

          elif [ "$UTC_HOUR" = "08" ]; then
            pick_slot "SLOT3"

          elif [ "$UTC_HOUR" = "12" ]; then
            pick_slot "SLOT4"

          else
            # ====== ä¸åœ¨æ—¶é—´çª—ï¼šåªæœ‰æ‰‹åŠ¨ + force_run=true æ‰å…è®¸ ======
            if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_run }}" = "true" ]; then
              echo "ðŸ§ª Manual test mode: force run SLOT2"
              pick_slot "SLOT2"
            else
              echo "â° Not in any slot window and not forced. Exit."
              exit 0
            fi
          fi

        env:
          NW_SLOT1_USER: ${{ secrets.NW_SLOT1_USER }}
          NW_SLOT1_PASS: ${{ secrets.NW_SLOT1_PASS }}
          NW_SLOT2_USER: ${{ secrets.NW_SLOT2_USER }}
          NW_SLOT2_PASS: ${{ secrets.NW_SLOT2_PASS }}
          NW_SLOT3_USER: ${{ secrets.NW_SLOT3_USER }}
          NW_SLOT3_PASS: ${{ secrets.NW_SLOT3_PASS }}
          NW_SLOT4_USER: ${{ secrets.NW_SLOT4_USER }}
          NW_SLOT4_PASS: ${{ secrets.NW_SLOT4_PASS }}

      # ========== è¿è¡Œç­¾åˆ°è„šæœ¬ ==========
      - name: Run signin
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python help.py

      # ========== æäº¤ç­¾åˆ°æ ‡è®°æ–‡ä»¶ ==========
      - name: Commit mark
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "bot@github.com"

          if ls SIGNED_*.txt 1> /dev/null 2>&1; then
            git add SIGNED_*.txt
            git commit -m "mark: update signin status" || echo "Nothing to commit"
            git push
          else
            echo "No SIGNED file generated"
          fi

      # ========== ä¸Šä¼ æ—¥å¿—å’Œæˆªå›¾ ==========
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_*.txt
