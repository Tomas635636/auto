name: Neworld Multi Account Signin

on:
  schedule:
    # ===== Slot1: 00:00 ~ 04:00 UTC =====
    # 00:00, 00:20, 00:40
    # 01:00, 01:20, 01:40
    # 02:00, 02:20, 02:40
    # 03:00, 03:20, 03:40
    - cron: "0,20,40 0 * * *"
    - cron: "0,20,40 1 * * *"
    - cron: "0,20,40 2 * * *"
    - cron: "0,20,40 3 * * *"

    # ===== Slot2: 03:05 ~ 07:05 UTC =====
    # 从 03:10 开始
    # 03:10, 03:30, 03:50
    # 04:10, 04:30, 04:50
    # 05:10, 05:30, 05:50
    # 06:10, 06:30, 06:50
    - cron: "10,30,50 3 * * *"
    - cron: "10,30,50 4 * * *"
    - cron: "10,30,50 5 * * *"
    - cron: "10,30,50 6 * * *"

    # ===== Slot3: 07:05 ~ 11:05 UTC =====
    # 从 07:10 开始
    # 07:10, 07:30, 07:50
    # 08:10, 08:30, 08:50
    # 09:10, 09:30, 09:50
    # 10:10, 10:30, 10:50
    - cron: "10,30,50 7 * * *"
    - cron: "10,30,50 8 * * *"
    - cron: "10,30,50 9 * * *"
    - cron: "10,30,50 10 * * *"

    # ===== Slot4: 11:05 ~ 15:05 UTC =====
    # 从 11:10 开始
    # 11:10, 11:30, 11:50
    # 12:10, 12:30, 12:50
    # 13:10, 13:30, 13:50
    # 14:10, 14:30, 14:50
    - cron: "10,30,50 11 * * *"
    - cron: "10,30,50 12 * * *"
    - cron: "10,30,50 13 * * *"
    - cron: "10,30,50 14 * * *"

  # ===== 手动触发（用于测试） =====
  workflow_dispatch:
    inputs:
      test_slot:
        description: "选择要测试的账号槽位（SLOT1~SLOT4）"
        required: true
        default: "SLOT2"
        type: choice
        options:
          - SLOT1
          - SLOT2
          - SLOT3
          - SLOT4

permissions:
  contents: write

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager requests

      # ========== 根据 UTC 时间或手动输入选择 slot ==========
      - name: Select account by time slot
        shell: bash
        run: |
          UTC_HOUR=$(date -u +"%H")
          UTC_MIN=$(date -u +"%M")
          echo "UTC time: $UTC_HOUR:$UTC_MIN"

          pick_slot() {
            SLOT="$1"
            USER_VAR="NW_${SLOT}_USER"
            PASS_VAR="NW_${SLOT}_PASS"

            USER="${!USER_VAR}"
            PASS="${!PASS_VAR}"

            echo "SLOT_NAME=$SLOT" >> $GITHUB_ENV
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          # ===== 手动触发：用你选择的 slot =====
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run detected, using slot: ${{ inputs.test_slot }}"
            echo "MANUAL_SLOT=${{ inputs.test_slot }}" >> $GITHUB_ENV
            pick_slot "${{ inputs.test_slot }}"
            exit 0
          fi

          # ===== 自动定时：按 UTC 小时选 slot（粗分流，真正防重复在 help.py） =====
          if [ "$UTC_HOUR" -ge 0 ] && [ "$UTC_HOUR" -lt 4 ]; then
            pick_slot "SLOT1"
          elif [ "$UTC_HOUR" -ge 3 ] && [ "$UTC_HOUR" -lt 7 ]; then
            pick_slot "SLOT2"
          elif [ "$UTC_HOUR" -ge 7 ] && [ "$UTC_HOUR" -lt 11 ]; then
            pick_slot "SLOT3"
          elif [ "$UTC_HOUR" -ge 11 ] && [ "$UTC_HOUR" -lt 15 ]; then
            pick_slot "SLOT4"
          else
            echo "Not in any slot window, exit."
            exit 0
          fi

        env:
          NW_SLOT1_USER: ${{ secrets.NW_SLOT1_USER }}
          NW_SLOT1_PASS: ${{ secrets.NW_SLOT1_PASS }}
          NW_SLOT2_USER: ${{ secrets.NW_SLOT2_USER }}
          NW_SLOT2_PASS: ${{ secrets.NW_SLOT2_PASS }}
          NW_SLOT3_USER: ${{ secrets.NW_SLOT3_USER }}
          NW_SLOT3_PASS: ${{ secrets.NW_SLOT3_PASS }}
          NW_SLOT4_USER: ${{ secrets.NW_SLOT4_USER }}
          NW_SLOT4_PASS: ${{ secrets.NW_SLOT4_PASS }}

      # ========== 执行签到 ==========
      - name: Run signin
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python help.py

      # ========== 提交 SIGNED 文件 ==========
      - name: Commit signin logs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "bot@github.com"

          git add SIGNED_*.txt || true
          git commit -m "chore: update signin logs" || echo "Nothing to commit"
          git push || true

      # ========== 上传日志（不入库） ==========
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_*.txt
