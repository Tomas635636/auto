name: Neworld Multi Account Signin

on:
  # ===== 仅保留手动 / Worker 触发 =====
  workflow_dispatch:
    inputs:
      test_slot:
        description: "选择要运行的账号槽位（SLOT1~SLOT4）"
        required: true
        default: "SLOT1"
        type: choice
        options:
          - SLOT1
          - SLOT2
          - SLOT3
          - SLOT4

permissions:
  contents: write

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager requests

      # ========== 根据 Worker 传入的 slot 选择账号 ==========
      - name: Select account by slot input
        shell: bash
        run: |
          SLOT="${{ inputs.test_slot }}"
          echo "Using slot: $SLOT"

          pick_slot() {
            SLOT_NAME="$1"
            USER_VAR="NW_${SLOT_NAME}_USER"
            PASS_VAR="NW_${SLOT_NAME}_PASS"

            USER="${!USER_VAR}"
            PASS="${!PASS_VAR}"

            # ===== 如果没配置：标记并正常退出 =====
            if [ -z "$USER" ] || [ -z "$PASS" ]; then
              echo "⚠️ Slot $SLOT_NAME is not configured, skipping."

              echo "SKIP_RUN=1" >> $GITHUB_ENV
              echo "SLOT_NAME=$SLOT_NAME" >> $GITHUB_ENV

              exit 0
            fi

            echo "SKIP_RUN=0" >> $GITHUB_ENV
            echo "SLOT_NAME=$SLOT_NAME" >> $GITHUB_ENV
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          pick_slot "$SLOT"

        env:
          NW_SLOT1_USER: ${{ secrets.NW_SLOT1_USER }}
          NW_SLOT1_PASS: ${{ secrets.NW_SLOT1_PASS }}
          NW_SLOT2_USER: ${{ secrets.NW_SLOT2_USER }}
          NW_SLOT2_PASS: ${{ secrets.NW_SLOT2_PASS }}
          NW_SLOT3_USER: ${{ secrets.NW_SLOT3_USER }}
          NW_SLOT3_PASS: ${{ secrets.NW_SLOT3_PASS }}
          NW_SLOT4_USER: ${{ secrets.NW_SLOT4_USER }}
          NW_SLOT4_PASS: ${{ secrets.NW_SLOT4_PASS }}

      # ========== 执行签到（仅当没有被跳过） ==========
      - name: Run signin
        if: env.SKIP_RUN != '1'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "===================================="
          echo "Running slot: $SLOT_NAME"
          echo "Using user: $USERNAME"
          echo "===================================="
          python help.py

      # ========== 提交 SIGNED 文件 ==========
      - name: Commit signin logs
        if: env.SKIP_RUN != '1'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "bot@github.com"

          git add SIGNED_*.txt || true
          git commit -m "chore: update signin logs" || echo "Nothing to commit"
          git push || true

      # ========== 上传日志（不入库） ==========
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_*.txt
