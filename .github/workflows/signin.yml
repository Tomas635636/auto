name: Neworld Multi Account Signin

on:
  schedule:
    # 北京时间 09:10
    - cron: "10 1 * * *"
    # 北京时间 13:10
    - cron: "10 5 * * *"
    # 北京时间 17:55
    - cron: "55 9 * * *"
    # 北京时间 21:55
    - cron: "55 13 * * *"
  workflow_dispatch:

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Select account by time slot
        run: |
          HOUR=$(date -u +"%H")
          MIN=$(date -u +"%M")
          echo "UTC time = $HOUR:$MIN"

          pick_slot_1() {
            USER="${{ secrets.NW_SLOT1_USER }}"
            PASS="${{ secrets.NW_SLOT1_PASS }}"
            if [ -z "$USER" ] || [ -z "$PASS" ]; then exit 0; fi
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          pick_slot_2() {
            USER="${{ secrets.NW_SLOT2_USER }}"
            PASS="${{ secrets.NW_SLOT2_PASS }}"
            if [ -z "$USER" ] || [ -z "$PASS" ]; then exit 0; fi
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          pick_slot_3() {
            USER="${{ secrets.NW_SLOT3_USER }}"
            PASS="${{ secrets.NW_SLOT3_PASS }}"
            if [ -z "$USER" ] || [ -z "$PASS" ]; then exit 0; fi
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          pick_slot_4() {
            USER="${{ secrets.NW_SLOT4_USER }}"
            PASS="${{ secrets.NW_SLOT4_PASS }}"
            if [ -z "$USER" ] || [ -z "$PASS" ]; then exit 0; fi
            echo "USERNAME=$USER" >> $GITHUB_ENV
            echo "PASSWORD=$PASS" >> $GITHUB_ENV
          }

          # 判断 slot（UTC）
          if [ "$HOUR" = "1" ]; then
            pick_slot_1
          elif [ "$HOUR" = "5" ]; then
            pick_slot_2
          elif [ "$HOUR" = "9" ]; then
            pick_slot_3
          elif [ "$HOUR" = "13" ]; then
            pick_slot_4
          else
            echo "Not in any slot window."
            exit 0
          fi

      - name: Run signin script
        run: |
          python help.py

      - name: Commit signin mark if exists
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "github-bot"
          if [ -f SIGNED_OK.txt ]; then
            git add SIGNED_OK.txt
            git commit -m "mark: signed ok"
            git push
          else
            echo "No signin mark file"
          fi

      - name: Upload logs and screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signin-log
          path: |
            *.png
            run.log
            SIGNED_OK.txt
